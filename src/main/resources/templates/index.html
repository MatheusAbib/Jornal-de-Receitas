<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jornal de Receitas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="header-full-width">
  <div class="header-container">
    <header class="newspaper-header">
      <div class="header-top">
        <div class="newspaper-price">Edição #01</div>
        <div class="newspaper-volume">
          <span class="menu-icon" id="menuToggle"><i class="fas fa-bars"></i></span>
          
          <!-- Ícone do usuário aparece apenas se estiver logado -->
          <span sec:authorize="isAuthenticated()" class="user-icon" id="userIcon">
            <i class="fas fa-user-circle"></i>
          </span>
          
          <!-- ícone de login quando não estiver logado -->
          <span sec:authorize="!isAuthenticated()" class="user-icon" id="loginIcon" 
                onclick="openLoginModal(); return false;" style="cursor: pointer;">
            <i class="fas fa-sign-in-alt"></i>
          </span>
        </div>
      </div>
      
      <h1 class="newspaper-title">Jornal de Receitas</h1>
      <p class="newspaper-subtitle" th:if="${nomeUsuario != null}">
          Bem vindo, <span th:text="${nomeUsuario}"></span>!
      </p>
      <p class="newspaper-subtitle" th:if="${nomeUsuario == null}">
          Delícias do dia a dia para todos os gostos
      </p>
      <p class="newspaper-subtitle" th:if="${nomeUsuario == null}">
          Faça Login ou Cadastre-se
      </p>
      <p class="newspaper-date" id="newspaperDate"></p> 
    </header>
  </div>
</div>

  <!-- SIDEBAR -->
<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <h3>Jornal de Receitas</h3>
    <a th:href="@{/}"><i class="fas fa-home"></i> Início</a>
    
    <!-- Apenas mostra "Se Cadastrar" quando NÃO estiver logado -->
    <a sec:authorize="!isAuthenticated()" th:href="@{/cadastro}">
        <i class="fas fa-user-plus"></i> Se Cadastrar
    </a>
    
    <!-- Apenas mostra "Fazer Login" quando NÃO estiver logado -->
    <a sec:authorize="!isAuthenticated()" href="#" onclick="openLoginModal(); return false;">
        <i class="fas fa-sign-in-alt"></i> Fazer Login
    </a>
    
    <!-- Apenas ADMIN vê Usuários -->
    <a sec:authorize="hasRole('ADMIN')" th:href="@{/usuarios}">
        <i class="fas fa-users"></i> Usuários
    </a>    
    
    <!-- Apenas ADMIN vê Receitas Pendentes -->
    <a sec:authorize="hasRole('ADMIN')" href="/pendentes">
        <i class="fas fa-clock"></i> Receitas Pendentes
    </a>
    
    <!-- Apenas usuários logados veem Nova Receita -->
    <a sec:authorize="isAuthenticated()" href="/nova">
        <i class="fas fa-utensils"></i> Nova Receita
    </a>    
    
    <!-- Botão Sair - Aparece apenas para usuários logados -->
    <a sec:authorize="isAuthenticated()" href="#" onclick="openLogoutModal(); return false;">
        <i class="fas fa-sign-out-alt"></i> Sair
    </a>
</div>

  <!-- CONTEÚDO COM MARGENS -->
  <div class="content-wrapper">
    <nav class="nav-links">
      <!-- Apenas ADMIN vê Receitas Pendentes -->
      <a sec:authorize="hasRole('ADMIN')" href="/pendentes">
        <i class="fas fa-clock"></i> Receitas Pendentes
      </a>
        <a sec:authorize="isAuthenticated()" href="/nova"><i class="fas fa-plus-circle"></i> Nova Receita</a>
    </nav>

  <!-- Abas de conteúdo -->
  <div class="content-tabs">
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="todas-receitas">
        Todas as Receitas
      </button>
      <button class="tab-button" data-tab="favoritas" id="fav">
        <i class="fas fa-heart"></i> Favoritas
        <span class="badge" id="favorite-count">0</span>
      </button>
    </div>
    
    
    <div class="tab-content active" id="todas-receitas">
      <div class="carousel-container">
        <div class="carousel">
          <div class="carousel-inner">
            <!-- ITENS DO CARROSSEL DINÂMICOS -->
            <div class="carousel-item" th:each="item : ${carrosselItens}" th:classappend="${itemStat.first} ? 'active'">
              <img th:src="${item.imagemUrl}" th:alt="${item.titulo}">
              <div class="carousel-caption">
                <h3 th:text="${item.titulo}">Título do Slide</h3>
                <p th:text="${item.descricao}">Descrição do slide</p>
              </div>
            </div>
          </div>
          <div class="carousel-controls">
            <button class="carousel-control prev"><i class="fas fa-chevron-left"></i></button>
            <button class="carousel-control next"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="carousel-indicators">
            <!-- INDICADORES DINÂMICOS -->
            <div class="carousel-indicator" 
                 th:each="item, itemStat : ${carrosselItens}"
                 th:classappend="${itemStat.first} ? 'active'"></div>
                 
            <!-- FALLBACK SE NÃO HOUVER ITENS -->
            <div class="carousel-indicator active" th:if="${#lists.isEmpty(carrosselItens)}"></div>
            <div class="carousel-indicator" th:if="${#lists.isEmpty(carrosselItens)}"></div>
            <div class="carousel-indicator" th:if="${#lists.isEmpty(carrosselItens)}"></div>
          </div>
        </div>
      </div>

        <div class="news-highlights">
          <div class="news-item">
            <div class="news-header">
              <div class="news-icon"><i class="fas fa-bullhorn"></i></div>
              <div class="news-title">Novidade na Plataforma</div>
            </div>
            <div class="news-content">
              <p class="news-description">Nova receita enviada: Torta de Limão com raspas de chocolate branco</p>
              <div class="news-date">
                <i class="far fa-clock"></i> Publicado há 2 horas
              </div>
            </div>
          </div>

          <div class="news-item">
            <div class="news-header">
              <div class="news-icon"><i class="fas fa-star"></i></div>
              <div class="news-title">Receita em Destaque</div>
            </div>
            <div class="news-content">
              <p class="news-description">Lasanha de Berinjela: Uma opção vegetariana incrível que conquistou nossos leitores</p>
              <div class="news-date">
                <i class="far fa-clock"></i> Em destaque esta semana
              </div>
            </div>
          </div>

          <div class="news-item">
            <div class="news-header">
              <div class="news-icon"><i class="fas fa-utensils"></i></div>
              <div class="news-title">Receita para o seu dia</div>
            </div>
            <div class="news-content">
              <p class="news-description">Brownie Fofinho: A receita mais acessada do dia com chocolate 70% cacau</p>
              <div class="news-date">
                <i class="far fa-clock"></i> Atualizado hoje
              </div>
            </div>
          </div>

          <div class="news-item">
            <div class="news-header">
              <div class="news-icon"><i class="fas fa-bowl-food"></i></div>
              <div class="news-title">Clássico Revitalizado</div>
            </div>
            <div class="news-content">
              <p class="news-description">Panqueca Americana: Nova versão com toque de canela e baunilha</p>
              <div class="news-date">
                <i class="far fa-clock"></i> Receita tradicional
              </div>
            </div>
          </div>
        </div>


<!-- Área de filtros -->
<div class="recipe-filters">
  <h3><i class="fas fa-filter"></i> Filtrar Receitas</h3>
  <form id="filterForm">
    <div class="filter-group">
      <label for="nome"><i class="fas fa-utensils"></i> Nome:</label>
      <i class="fas fa-search filter-icon"></i>
      <input type="text" id="nome" name="nome" placeholder="Digite o nome da receita">
    </div>
    
    <div class="filter-group">
      <label for="tempo"><i class="fas fa-clock"></i> Tempo de Preparo (min):</label>
      <i class="fas fa-hourglass-half filter-icon"></i>
      <input type="number" id="tempo" name="tempo" min="1" placeholder="Máx. tempo">
    </div>
    
    <div class="filter-group">
      <label for="porcoes"><i class="fas fa-users"></i> Porções:</label>
      <i class="fas fa-user filter-icon"></i>
      <input type="number" id="porcoes" name="porcoes" min="1" placeholder="Quantidade de porções">
    </div>

    <div class="filter-buttons">
      <button type="button" id="aplicarFiltros">
        <i class="fas fa-check"></i> Aplicar Filtros
      </button>
      <button type="button" id="limparFiltros">
        <i class="fas fa-times"></i> Limpar Filtros
      </button>
    </div>
  </form>
</div>


<div class="receitas" id="all-recipes">
  <div class="card" th:each="r : ${receitas}">
    <div class="card-image">
      <img th:if="${r.imagem != null and r.imagem.startsWith('http')}" th:src="${r.imagem}" alt="Imagem da receita">
      <img th:if="${r.imagem != null and !r.imagem.startsWith('http')}" th:src="@{'/uploads/' + ${r.imagem}}" alt="Imagem da receita">
      <img th:if="${r.imagem == null}" src="/default-image.jpg" alt="Sem imagem">
      <div class="card-badge">NOVO</div>
    </div>
    <div class="card-content">
      <h2 th:text="${r.titulo}">Título da Receita</h2>
      
      <div class="card-meta">
        <span><i class="fas fa-clock"></i> <span th:text="${r.tempoPreparo}">30 min</span></span>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <span><i class="fas fa-utensils"></i> <span th:text="${r.porcoes}">1</span> porções</span>
      </div>
      
      <p>Experimente essa receita deliciosa e compartilhe com amigos e familiares. Perfeita para ocasiões especiais!</p>
      
      <div class="card-actions">
        <a th:href="@{/detalhe/{id}(id=${r.id})}" class="card-link">Ver receita <i class="fas fa-arrow-right"></i></a>
        <button class="card-favorite" th:attr="data-recipe-id=${r.id}">
          <i class="far fa-heart"></i>
        </button>
        <!-- Botão de excluir - apenas para ADMIN -->
        <button sec:authorize="hasRole('ADMIN')" class="card-delete" 
                th:attr="data-recipe-id=${r.id}" 
                th:data-recipe-title="${r.titulo}">
            <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>
</div>

      <div class="section-title">
        <h2>Receitas Rápidas</h2>
        <p>Pratos deliciosos que você prepara em pouco tempo</p>
      </div>
      
      <div class="classifieds" id="classifieds">
        <div class="classified-item">
          <div class="classified-image">
            <img src="/uploads/pesto.jpg" alt="Espaguete ao Pesto">
            <div class="classified-badge">RÁPIDO</div>
          </div>
          <div class="classified-content">
            <h3>Espaguete ao Pesto</h3>
            <div class="classified-meta">
              <span><i class="fas fa-clock"></i> 25 min</span>
              <span><i class="fas fa-user"></i> 2 porções</span>
            </div>
            <p class="classified-description">Massa italiana com pesto de manjericão fresco e pinoli. Um clássico da culinária mediterrânea.</p>
            <div class="classified-actions">
              <a href="https://www.tudogostoso.com.br/receita/24230-espaguete-ao-pesto.html" target="_blank" class="classified-link">Ver Receita <i class="fas fa-arrow-right"></i></a>
              <span class="classified-price">Fácil</span>
            </div>
          </div>
        </div>
        <div class="classified-item">
          <div class="classified-image">
            <img src="/uploads/sopa.jpg" alt="Sopa de Abóbora">
            <div class="classified-badge">SAUDÁVEL</div>
          </div>
          <div class="classified-content">
            <h3>Sopa de Abóbora</h3>
            <div class="classified-meta">
              <span><i class="fas fa-clock"></i> 40 min</span>
              <span><i class="fas fa-user"></i> 4 porções</span>
            </div>
            <p class="classified-description">Creme de abóbora com gengibre e toque de noz-moscada. Perfecta para dias frios.</p>
            <div class="classified-actions">
              <a href="https://www.tudogostoso.com.br/receita/131045-sopa-de-abobora.html" target="_blank" class="classified-link">Ver Receita <i class="fas fa-arrow-right"></i></a>
              <span class="classified-price">Médio</span>
            </div>
          </div>
        </div>

          <div class="classified-item">
          <div class="classified-image">
            <img src="/uploads/ganache.jpg" alt="Sopa de Abóbora">
            <div class="classified-badge">SOBREMESA</div>
          </div>
          <div class="classified-content">
            <h3>Ganache</h3>
            <div class="classified-meta">
              <span><i class="fas fa-clock"></i> 12 min</span>
              <span><i class="fas fa-user"></i> 4 porções</span>
            </div>
            <p class="classified-description">Calda de chocolate deliciosa para adicionar em suas sobremesas.</p>
            <div class="classified-actions">
              <a href="https://www.tudogostoso.com.br/receita/21429-ganache.html" target="_blank" class="classified-link">Ver Receita <i class="fas fa-arrow-right"></i></a>
              <span class="classified-price">Médio</span>
            </div>
          </div>
        </div>

        <div class="classified-item">
          <div class="classified-image">
            <img src="/uploads/bolinho-chuva.jpg" alt="Bolinhos de Chuva">
            <div class="classified-badge">SOBREMESA</div>
          </div>
          <div class="classified-content">
            <h3>Bolinhos de Chuva</h3>
            <div class="classified-meta">
              <span><i class="fas fa-clock"></i> 20 min</span>
              <span><i class="fas fa-user"></i> 6 porções</span>
            </div>
            <p class="classified-description">Clássica receita de bolinhos fofinhos com canela e açúcar. Ideal para o lanche da tarde.</p>
            <div class="classified-actions">
              <a href="https://www.tudogostoso.com.br/receita/76049-bolinho-de-chuva.html" target="_blank" class="classified-link">Ver Receita <i class="fas fa-arrow-right"></i></a>
              <span class="classified-price">Fácil</span>
            </div>
          </div>
        </div>
      </div>

      <div class="advertisement">
        <h2>Ofertas Especiais de Utensílios!</h2>
        <p>Aproveite nossas ofertas semanais de utensílios de cozinha com até 40% de desconto!</p>
        <a href="#" class="btn">Ver Ofertas</a>
      </div>
    </div>
    
    <div class="tab-content" id="favoritas">
      <div class="empty-state" id="empty-favorites">
        <i class="fas fa-heart"></i>
        <h2>Nenhuma receita favoritada</h2>
        <p>Você ainda não favoritou nenhuma receita. Clique no coração nas receitas para adicioná-las aos favoritos.</p>
      </div>
      
      <div class="receitas" id="favorite-recipes">
        <!-- As receitas favoritas serão carregadas via JavaScript -->
      </div>
    </div>
  </div>

  <footer class="newspaper-footer">
    <div class="footer-content">
      <div class="footer-column">
        <h3>Jornal de Receitas</h3>
        <p>O seu destino para encontrar as melhores receitas caseiras e dicas culinárias.</p>
      </div>
      <div class="footer-column">
        <h3>Links Rápidos</h3>
        <ul>
          <li><a href="#"><i class="fas fa-utensils"></i> Receitas</a></li>
          <li><a href="#"><i class="fas fa-book"></i> Cadastrar Receitas</a></li>
          <li><a href="#classifieds"><i class="fas fa-star"></i> Destaques</a></li>
          <li><a href="#"><i class="fas fa-question-circle"></i> Sobre Nós</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Contato</h3>
        <ul>
          <li><a href="#"><i class="fas fa-envelope"></i> contato@jornaldereceitas.com</a></li>
          <li><a href="#"><i class="fas fa-phone"></i> (11) 9999-9999</a></li>
          <li><a href="#"><i class="fas fa-map-marker-alt"></i> São Paulo, Brasil</a></li>
        </ul>
      </div>
    </div>
    
    <div class="social-links">
      <a href="#"><i class="fab fa-facebook-f"></i></a>
      <a href="#"><i class="fab fa-instagram"></i></a>
      <a href="#"><i class="fab fa-pinterest"></i></a>
      <a href="#"><i class="fab fa-youtube"></i></a>
    </div>
    
    <div class="footer-bottom">
      <p>© 2025 Jornal de Receitas - Todos os direitos reservados</p>
    </div>
  </footer>

<!-- Modal de Login  -->
<div id="loginModal" class="modal login-modal">
  <div class="modal-content-login">
    <span class="close close-login-modal">&times;</span>
    <div class="modal-header-login">
      <h2><i class="fas fa-sign-in-alt"></i> Acessar Conta</h2>
    </div>
    
    <div class="modal-body-login">

      <!-- Mensagem de erro será inserida aqui via JavaScript -->
      <div id="loginError" class="login-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
      </div>
      
      <form id="loginForm" th:action="@{/login}" method="post">
        <div class="form-group-login">
          <label for="username">
            <i class="fas fa-envelope"></i> Email
          </label>
          <div class="input-with-icon">
            <i class="fas fa-at"></i>
            <input type="email" 
                   id="username" 
                   name="username" 
                   class="form-control-login" 
                   placeholder="seu@email.com" 
                   required
                   autocomplete="email">
          </div>
        </div>
        
        <div class="form-group-login">
          <label for="password">
            <i class="fas fa-lock"></i> Senha
          </label>
          <div class="input-with-icon">
            <i class="fas fa-key"></i>
            <input type="password" 
                   id="password" 
                   name="password" 
                   class="form-control-login" 
                   placeholder="Digite sua senha" 
                   required
                   autocomplete="current-password">
          </div>
        </div>
        
        <div class="login-options">
          <label class="remember-me">
            <input type="checkbox" id="remember" name="remember">
            Lembrar-me
          </label>
          <a href="#" class="forgot-password">
            Esqueci a senha
          </a>
        </div>
        
        <button type="submit" class="login-button">
          <i class="fas fa-sign-in-alt"></i>
          <span class="button-text">Entrar</span>
        </button>
      </form>
      
      <div class="register-link">
        Não tem uma conta?
        <a href="/cadastro">Cadastre-se aqui</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal de informações do usuário -->
<div id="userModal" class="modal">
  <div class="modal-content-user">
    <div class="modal-header">
      <h2><i class="fas fa-user-edit"></i> Editar Perfil</h2>
      <span class="close close-user-modal">&times;</span>
    </div>
    <div class="modal-body">
      <form id="userEditForm">
        <div class="user-info-grid">
          <div class="form-group">
            <label for="editNome"><i class="fas fa-user"></i> Nome</label>
            <input type="text" id="editNome" name="nome" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="editEmail"><i class="fas fa-envelope"></i> Email</label>
            <input type="email" id="editEmail" name="email" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="editCpf"><i class="fas fa-id-card"></i> CPF</label>
            <input type="text" id="editCpf" name="cpf" class="form-input" readonly>
          </div>
          <div class="form-group">
            <label for="editTelefone"><i class="fas fa-phone"></i> Telefone</label>
            <input type="tel" id="editTelefone" name="telefone" class="form-input">
          </div>
          <div class="form-group">
            <label for="editGenero"><i class="fas fa-venus-mars"></i> Gênero</label>
            <select id="editGenero" name="genero" class="form-input">
              <option value="">Selecione</option>
              <option value="MASCULINO">Masculino</option>
              <option value="FEMININO">Feminino</option>
              <option value="OUTRO">Outro</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="editDataCadastro"><i class="fas fa-calendar-alt"></i> Data de Cadastro</label>
            <input type="text" id="editDataCadastro" class="form-input" readonly>
          </div>
          <div class="form-group full-width">
            <label for="editSenha"><i class="fas fa-lock"></i> Nova Senha</label>
            <input type="password" id="editSenha" name="senha" class="form-input" placeholder="Digite nova senha">
          </div>
          <div class="form-group full-width">
            <label for="confirmarSenha"><i class="fas fa-lock"></i> Confirmar Nova Senha</label>
            <input type="password" id="confirmarSenha" name="confirmarSenha" class="form-input" placeholder="Confirme a nova senha">
          </div>
        </div>
        <div id="userEditMessage" class="message"></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="fecharModalUsuario()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Salvar Alterações
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="deleteModal" class="modal delete-modal">
  <div class="modal-content-delete">
    <span class="close close-delete-modal">&times;</span>
    <div class="modal-header-delete">
      <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
    </div>

    <div class="modal-message">
      Tem certeza que deseja excluir a receita
      <span class="recipe-name" id="recipeNameToDelete"></span>
    </div>
    <div class="modal-warning">
      <i class="fas fa-exclamation-circle"></i>
      Esta ação não pode ser desfeita. A receita será removida permanentemente.
    </div>
    <div class="modal-actions-delete">
      <button class="modal-button-delete cancel">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button class="modal-button-delete confirm">
        <i class="fas fa-trash"></i> Excluir
      </button>
    </div>
  </div>
</div>

  <!-- Modal de Logout -->
<div id="logoutModal" class="modal logout-modal">
  <div class="modal-content-logout">
    <div class="modal-header-logout">
      <h2><i class="fas fa-sign-out-alt"></i> Sair da Conta</h2>
      <span class="close close-logout-modal">&times;</span>
    </div>

    
    <div class="modal-message">
      Tem certeza que deseja sair da sua conta?
      <br>
      Você precisará fazer login novamente para acessar recursos exclusivos.
    </div>
    
    <div class="modal-actions">
      <button class="modal-button cancel">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button class="modal-button logout">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>
</div>
</div>


<script>
  // ===================== FUNÇÕES GLOBAIS =====================
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar) {
    sidebar.classList.toggle('show');
    
    // Prevenir rolagem do body quando sidebar está aberta
    if (sidebar.classList.contains('show')) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
  }
}

function verificarUsuarioAutenticado() {
  const nomeUsuarioElement = document.querySelector('.newspaper-subtitle span');
  const estaLogado = nomeUsuarioElement && nomeUsuarioElement.textContent.trim();
  
  if (estaLogado) {
    const userIcon = document.getElementById('userIcon');
    if (userIcon) {
      userIcon.style.cursor = 'pointer';
      userIcon.title = 'Ver meu perfil';
    }
  }
}

function configurarIconeUsuario() {
  const userIcon = document.getElementById('userIcon');
  const nomeUsuarioElement = document.querySelector('.newspaper-subtitle span');
  const estaLogado = nomeUsuarioElement && nomeUsuarioElement.textContent.trim();
  
  if (userIcon && estaLogado) {
    userIcon.style.display = 'inline-flex';
    userIcon.style.cursor = 'pointer';
    userIcon.title = 'Ver meu perfil';
    userIcon.onclick = function() {
      console.log('Ícone do usuário clicado');
      abrirModalUsuarioSimples(); // Chamar a nova função
    };
  } else if (userIcon) {
    // Se não estiver logado, esconder o ícone
    userIcon.style.display = 'none';
  }
}

async function abrirModalUsuarioSimples() {
  const modal = document.getElementById('userModal');
  
  if (!modal) {
    console.error('Modal do usuário não encontrado');
    return;
  }
  
  console.log('Abrindo modal do usuário...');
  
  // Mostrar loading
  const messageEl = document.getElementById('userEditMessage');
  if (messageEl) {
    messageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando dados do usuário...';
    messageEl.className = 'message info';
  }
  
  try {
    // Buscar dados do usuário logado via API
    const response = await fetch('/perfil/usuario-logado', {
      credentials: 'include' 
    });    
    if (response.ok) {
      const data = await response.json();
      const usuario = data.usuario;
      
      console.log('Dados do usuário recebidos:', usuario);
      
      // Preencher os campos do formulário
      if (document.getElementById('editNome')) {
        document.getElementById('editNome').value = usuario.nome || '';
      }
      if (document.getElementById('editEmail')) {
        document.getElementById('editEmail').value = usuario.email || '';
      }
      if (document.getElementById('editCpf')) {
        document.getElementById('editCpf').value = usuario.cpf || '';
      }
      
      // TELEFONE: formatar automaticamente
      if (document.getElementById('editTelefone')) {
        let telefoneValue = usuario.telefone || '';
        if (telefoneValue) {
          telefoneValue = formatarTelefone(telefoneValue);
        }
        document.getElementById('editTelefone').value = telefoneValue;
      }
      
      if (document.getElementById('editGenero')) {
        // Configurar o valor do select
        const generoSelect = document.getElementById('editGenero');
        const generoValue = (usuario.genero || '').toUpperCase();
        generoSelect.value = generoValue;
      }
      if (document.getElementById('editDataCadastro')) {
        // Formatar a data
        let dataCadastro = usuario.dataCadastro || '';
        if (dataCadastro) {
          try {
            // Remover timezone se existir
            const dataString = dataCadastro.split('T')[0];
            const [ano, mes, dia] = dataString.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            document.getElementById('editDataCadastro').value = dataFormatada;
          } catch (e) {
            document.getElementById('editDataCadastro').value = dataCadastro;
          }
        }
      }
      
      // Limpar campos de senha
      if (document.getElementById('editSenha')) {
        document.getElementById('editSenha').value = '';
      }
      if (document.getElementById('confirmarSenha')) {
        document.getElementById('confirmarSenha').value = '';
      }
      
      // Atualizar mensagem
      if (messageEl) {
        messageEl.innerHTML = '<i class="fas fa-info-circle"></i> Edite suas informações acima. Deixe a senha em branco para mantê-la inalterada.';
        messageEl.className = 'message info';
      }
      
    } else if (response.status === 401) {
      // Usuário não autenticado
      console.log('Usuário não autenticado');
      
      // Preencher apenas com o nome que aparece no header
      const nomeUsuarioElement = document.querySelector('.newspaper-subtitle span');
      const nomeUsuario = nomeUsuarioElement ? nomeUsuarioElement.textContent.trim() : '';
      
      if (document.getElementById('editNome')) {
        document.getElementById('editNome').value = nomeUsuario || '';
      }
      
      if (messageEl) {
        messageEl.innerHTML = '<i class="fas fa-info-circle"></i> Faça login para acessar todas as funcionalidades.';
        messageEl.className = 'message info';
      }
    } else {
      // Outro erro
      console.error('Erro na resposta:', response.status);
      if (messageEl) {
        messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro ao carregar dados do usuário.';
        messageEl.className = 'message error';
      }
    }
    
  } catch (error) {
    console.error('Erro ao buscar dados do usuário:', error);
    
    // Fallback em caso de erro
    const nomeUsuarioElement = document.querySelector('.newspaper-subtitle span');
    const nomeUsuario = nomeUsuarioElement ? nomeUsuarioElement.textContent.trim() : '';
    
    if (document.getElementById('editNome')) {
      document.getElementById('editNome').value = nomeUsuario || '';
    }
    
    if (messageEl) {
      messageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro de conexão ao carregar dados.';
      messageEl.className = 'message error';
    }
  }
  
  // Mostrar o modal
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Focar no primeiro campo
  setTimeout(() => {
    const nomeField = document.getElementById('editNome');
    if (nomeField) {
      nomeField.focus();
    }
  }, 300);
}

function openLogoutModal() {
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
}

function closeLogoutModal() {
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

function abrirModalUsuario(usuario) {
  const modal = document.getElementById('userModal');
  
  document.getElementById('editNome').value = usuario.nome || '';
  document.getElementById('editEmail').value = usuario.email || '';
  document.getElementById('editCpf').value = usuario.cpf || '';
  document.getElementById('editTelefone').value = usuario.telefone || '';
  document.getElementById('editGenero').value = (usuario.genero || '').toUpperCase().trim();
  document.getElementById('editDataCadastro').value = usuario.dataCadastro || '';
  document.getElementById('editSenha').value = '';
  document.getElementById('confirmarSenha').value = '';
  
  const messageEl = document.getElementById('userEditMessage');
  if (!usuario.email) {
    messageEl.innerHTML = '<i class="fas fa-info-circle"></i> Para editar seu perfil completo, faça login primeiro.';
    messageEl.className = 'message info';
  } else {
    messageEl.textContent = '';
    messageEl.className = 'message';
  }
  
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function fecharModalUsuario() {
  const modal = document.getElementById('userModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

function openLoginModal() {
  const loginModal = document.getElementById('loginModal');
  if (loginModal) {
    loginModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Limpar mensagens de erro anteriores
    hideLoginError();
    
    // Focar no primeiro campo
    setTimeout(() => {
      const usernameField = document.getElementById('username');
      if (usernameField) {
        usernameField.focus();
      }
    }, 300);
  }
}

function closeLoginModal() {
  const loginModal = document.getElementById('loginModal');
  if (loginModal) {
    loginModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Limpar formulário
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.reset();
    }
    hideLoginError();
  }
}

function showLoginError(message) {
  const errorDiv = document.getElementById('loginError');
  const errorMessage = document.getElementById('errorMessage');
  
  if (errorDiv && errorMessage) {
    errorMessage.textContent = message;
    errorDiv.style.display = 'flex';
    
    // Adicionar efeito shake no formulário
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.classList.add('shake');
      setTimeout(() => loginForm.classList.remove('shake'), 500);
    }
  }
}

function hideLoginError() {
  const errorDiv = document.getElementById('loginError');
  if (errorDiv) {
    errorDiv.style.display = 'none';
  }
}

function showLoginSuccess() {
  const errorDiv = document.getElementById('loginError');
  const submitBtn = document.querySelector('.login-button');
  
  if (errorDiv && submitBtn) {
    // Mudar aparência do botão
    submitBtn.style.background = 'linear-gradient(135deg, #27ae60, #219653)';
    submitBtn.innerHTML = '<i class="fas fa-check"></i> Login realizado!';
    
    // Mostrar mensagem de sucesso
    errorDiv.innerHTML = '<i class="fas fa-check-circle"></i> Redirecionando...';
    errorDiv.style.display = 'flex';
    errorDiv.style.background = 'rgba(46, 204, 113, 0.1)';
    errorDiv.style.borderColor = 'rgba(46, 204, 113, 0.3)';
    errorDiv.style.color = '#27ae60';
  }
}

function showMessage(message, type) {
  const messageEl = document.getElementById('userEditMessage');
  if (messageEl) {
    messageEl.textContent = message;
    messageEl.className = `message ${type}`;
    
    if (type === 'success') {
      messageEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    } else {
      messageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    }
  }
}

// ===================== CÓDIGO PRINCIPAL =====================
document.addEventListener('DOMContentLoaded', function() {
  // ===================== SIDEBAR =====================
  const menuToggle = document.getElementById('menuToggle');
  if (menuToggle) {
    menuToggle.addEventListener('click', toggleSidebar);
  }
  
  
  // Fechar sidebar ao clicar fora (quando aberta)
  document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    if (sidebar && sidebar.classList.contains('show') && 
        !sidebar.contains(event.target) && 
        !menuToggle.contains(event.target)) {
      toggleSidebar();
    }
  });
  
  // Fechar sidebar com tecla ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('show')) {
        toggleSidebar();
      }
    }
  });

   const telefoneInput = document.getElementById('editTelefone');
  
  if (telefoneInput) {
    telefoneInput.addEventListener('input', function(e) {
      aplicarMascaraTelefoneInput(e.target);
    });
    
    // Também para quando o campo perde o foco (caso o usuário cole algo)
    telefoneInput.addEventListener('blur', function(e) {
      aplicarMascaraTelefoneInput(e.target);
    });
  }

  // ===================== CARROSSEL =====================
  function initializeCarousel() {
    const carousel = document.querySelector('.carousel-inner');
    const items = document.querySelectorAll('.carousel-item');
    const prevBtn = document.querySelector('.carousel-control.prev');
    const nextBtn = document.querySelector('.carousel-control.next');
    const indicators = document.querySelectorAll('.carousel-indicator');
    
    console.log('Itens do carrossel encontrados:', items.length);
    
    if (items.length === 0) {
      console.log('Nenhum item encontrado no carrossel');
      return;
    }
    
    let currentIndex = 0;
    const totalItems = items.length;
    
    function updateCarousel() {
      if (carousel) {
        carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
      }
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentIndex);
      });
      
      // Atualizar classe active nos itens
      items.forEach((item, index) => {
        item.classList.toggle('active', index === currentIndex);
      });
    }
    
    function nextSlide() {
      currentIndex = (currentIndex + 1) % totalItems;
      updateCarousel();
    }
    
    function prevSlide() {
      currentIndex = (currentIndex - 1 + totalItems) % totalItems;
      updateCarousel();
    }
    
    // Configurar botões
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);
    
    // Configurar indicadores
    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        currentIndex = index;
        updateCarousel();
      });
    });
    
    // Iniciar auto-play
    let carouselInterval = setInterval(nextSlide, 5000);
    const carouselContainer = document.querySelector('.carousel-container');
    if (carouselContainer) {
      carouselContainer.addEventListener('mouseenter', () => clearInterval(carouselInterval));
      carouselContainer.addEventListener('mouseleave', () => carouselInterval = setInterval(nextSlide, 5000));
    }
    
    // Inicializar
    updateCarousel();
    console.log(`Carrossel inicializado com ${totalItems} itens`);
  }

  // Inicializar o carrossel quando a página carregar
  initializeCarousel();

  // ===================== MODAL DE EXCLUSÃO =====================
  let currentRecipeToDelete = null;
  let currentDeleteButton = null;

  function initializeDeleteButtons() {
    const deleteButtons = document.querySelectorAll('.card-delete');
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        const recipeId = this.getAttribute('data-recipe-id');
        const recipeTitle = this.getAttribute('data-recipe-title');
        
        // Armazenar informações para usar no modal
        currentRecipeToDelete = recipeId;
        currentDeleteButton = this;
        
        // Abrir modal de confirmação
        openDeleteModal(recipeTitle);
      });
    });
  }

  function openDeleteModal(recipeTitle) {
    const modal = document.getElementById('deleteModal');
    const recipeNameElement = document.getElementById('recipeNameToDelete');
    
    if (modal && recipeNameElement) {
      // Definir o nome da receita no modal
      recipeNameElement.textContent = `"${recipeTitle}"`;
      
      // Mostrar modal
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
  }

  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Limpar variáveis
      currentRecipeToDelete = null;
      currentDeleteButton = null;
    }
  }

  function setupDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const closeBtn = document.querySelector('.close-delete-modal');
    const cancelBtn = document.querySelector('.delete-modal .cancel');
    const confirmBtn = document.querySelector('.delete-modal .confirm');
    
    // Fechar modal ao clicar no X
    if (closeBtn) {
      closeBtn.addEventListener('click', closeDeleteModal);
    }
    
    // Fechar modal ao clicar no botão Cancelar
    if (cancelBtn) {
      cancelBtn.addEventListener('click', closeDeleteModal);
    }
    
    // Confirmar exclusão
    if (confirmBtn) {
      confirmBtn.addEventListener('click', async function() {
        if (currentRecipeToDelete && currentDeleteButton) {
          // Desabilitar botão durante a exclusão
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
          
          await deleteRecipe(currentRecipeToDelete, currentDeleteButton);
          closeDeleteModal();
          
          // Reativar botão
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-trash"></i> Excluir';
        }
      });
    }
    
    // Fechar modal ao clicar fora
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeDeleteModal();
        }
      });
    }
  }

  async function deleteRecipe(recipeId, buttonElement) {
    try {
      console.log('Tentando excluir receita ID:', recipeId);
      
      const response = await fetch(`/rejeitar/${recipeId}`, {
        method: 'POST'
      });
      
      console.log('Resposta do servidor:', response.status, response.statusText);
      
      if (response.ok) {
        // Animação de exclusão
        const card = buttonElement.closest('.card');
        if (card) {
          card.style.animation = 'fadeOut 0.3s ease forwards';
          
          setTimeout(() => {
            card.remove();
            showDeleteNotification('Receita excluída com sucesso!', true);
            
            // Atualizar contagem se necessário
            updateCardCount();
          }, 300);
        }
        
        // Remover dos favoritos
        const favorites = JSON.parse(localStorage.getItem('recipeFavorites')) || [];
        const updatedFavorites = favorites.filter(id => id !== recipeId);
        localStorage.setItem('recipeFavorites', JSON.stringify(updatedFavorites));
        updateFavoriteCount();
        
        // Recarregar favoritos se a aba estiver aberta
        const favTab = document.getElementById('favoritas');
        if (favTab && favTab.classList.contains('active')) {
          loadFavoriteRecipes();
        }
        
        console.log('Receita excluída com sucesso!');
      } else {
        console.error('Erro ao excluir receita:', response.status);
        showDeleteNotification('Erro ao excluir receita', false);
      }
    } catch (error) {
      console.error('Erro na requisição:', error);
      showDeleteNotification('Erro de conexão', false);
    }
  }

  function updateCardCount() {
    const cards = document.querySelectorAll('#all-recipes .card');
    console.log(`Restam ${cards.length} receitas`);
  }

  function showDeleteNotification(message, isSuccess) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; bottom: 20px; right: 20px;
      background: ${isSuccess ? '#27ae60' : '#e74c3c'};
      color: white; padding: 12px 20px; border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000; display: flex; align-items: center; gap: 10px;
      opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
    `;
    notification.innerHTML = `<i class="fas ${isSuccess ? 'fa-check' : 'fa-exclamation'}"></i> ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => { notification.style.opacity = '1'; notification.style.transform = 'translateY(0)'; }, 10);
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(20px)';
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }

  // Adicionar animação CSS para exclusão
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
  `;
  document.head.appendChild(style);

  // Inicializar botões de excluir
  initializeDeleteButtons();
  setupDeleteModal();

  // ===================== ABAS =====================
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.getAttribute('data-tab');
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      tabContents.forEach(content => content.classList.remove('active'));
      const targetTab = document.getElementById(tabId);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      if (tabId === 'favoritas') loadFavoriteRecipes();
    });
  });

  // ===================== FAVORITOS =====================
  let favorites = JSON.parse(localStorage.getItem('recipeFavorites')) || [];

  function updateFavoriteCount() {
    const favoriteCount = document.getElementById('favorite-count');
    if (favoriteCount) {
      favoriteCount.textContent = favorites.length;
    }
  }

  function showFavoriteNotification(isFavorite) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; bottom: 20px; right: 20px;
      background: ${isFavorite ? 'var(--favorite-color)' : 'var(--header-color)'};
      color: white; padding: 12px 20px; border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000; display: flex; align-items: center; gap: 10px;
      opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
    `;
    notification.innerHTML = `<i class="fas ${isFavorite ? 'fa-heart' : 'fa-times'}"></i> ${isFavorite ? 'Receita adicionada aos favoritos!' : 'Receita removida dos favoritos!'}`;
    document.body.appendChild(notification);
    setTimeout(() => { notification.style.opacity = '1'; notification.style.transform = 'translateY(0)'; }, 10);
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(20px)';
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }

  function initializeFavoriteButtons() {
    const favoriteButtons = document.querySelectorAll('.card-favorite');
    favoriteButtons.forEach(button => {
      const recipeId = button.getAttribute('data-recipe-id');
      if (favorites.includes(recipeId)) {
        button.classList.add('active');
        const icon = button.querySelector('i');
        if (icon) {
          icon.classList.remove('far');
          icon.classList.add('fas');
        }
      }
      button.addEventListener('click', function() {
        const icon = this.querySelector('i');
        if (this.classList.contains('active')) {
          favorites = favorites.filter(id => id !== recipeId);
          this.classList.remove('active');
          if (icon) {
            icon.classList.remove('fas');
            icon.classList.add('far');
          }
        } else {
          favorites.push(recipeId);
          this.classList.add('active');
          if (icon) {
            icon.classList.remove('far');
            icon.classList.add('fas');
          }
        }
        localStorage.setItem('recipeFavorites', JSON.stringify(favorites));
        updateFavoriteCount();
        showFavoriteNotification(this.classList.contains('active'));
      });
    });
  }

  function loadFavoriteRecipes() {
    const favoriteContainer = document.getElementById('favorite-recipes');
    const emptyState = document.getElementById('empty-favorites');
    
    if (!favoriteContainer || !emptyState) return;
    
    favoriteContainer.innerHTML = '';
    if (favorites.length === 0) {
      emptyState.style.display = 'block';
      return;
    }
    emptyState.style.display = 'none';
    const allRecipeCards = document.querySelectorAll('#all-recipes .card');
    allRecipeCards.forEach(card => {
      const favoriteButton = card.querySelector('.card-favorite');
      if (favoriteButton) {
        const recipeId = favoriteButton.getAttribute('data-recipe-id');
        if (favorites.includes(recipeId)) {
          const clonedCard = card.cloneNode(true);
          const favButton = clonedCard.querySelector('.card-favorite');
          if (favButton) {
            favButton.classList.add('active');
            const icon = favButton.querySelector('i');
            if (icon) {
              icon.classList.remove('far');
              icon.classList.add('fas');
            }
            favButton.addEventListener('click', function() {
              favorites = favorites.filter(id => id !== recipeId);
              localStorage.setItem('recipeFavorites', JSON.stringify(favorites));
              updateFavoriteCount();
              this.closest('.card').remove();
              if (favorites.length === 0) emptyState.style.display = 'block';
              const mainButton = document.querySelector(`#all-recipes .card-favorite[data-recipe-id="${recipeId}"]`);
              if (mainButton) {
                mainButton.classList.remove('active');
                const mainIcon = mainButton.querySelector('i');
                if (mainIcon) {
                  mainIcon.classList.remove('fas');
                  mainIcon.classList.add('far');
                }
              }
              showFavoriteNotification(false);
            });
          }
          favoriteContainer.appendChild(clonedCard);
        }
      }
    });
  }

  initializeFavoriteButtons();
  updateFavoriteCount();

  // ===================== EFEITO DE DIGITAÇÃO =====================
  const titleElement = document.querySelector('.newspaper-title');
  if (titleElement) {
    const originalTitle = titleElement.textContent;
    titleElement.textContent = '';
    let charIndex = 0;
    function typeTitle() {
      if (charIndex < originalTitle.length) {
        titleElement.textContent += originalTitle.charAt(charIndex);
        charIndex++;
        setTimeout(typeTitle, 100);
      }
    }
    typeTitle();
  }

  // ===================== MODAL DE LOGIN =====================
  function setupLoginModal() {
    const loginModal = document.getElementById('loginModal');
    const closeBtn = document.querySelector('.close-login-modal');
    
    // Fechar modal
    if (closeBtn) {
      closeBtn.addEventListener('click', closeLoginModal);
    }
    
    // Fechar ao clicar fora
    if (loginModal) {
      loginModal.addEventListener('click', function(e) {
        if (e.target === loginModal) {
          closeLoginModal();
        }
      });
    }
    
    // Configurar link de login no sidebar
    const sidebarLoginLink = document.querySelector('a[onclick*="openLoginModal"]');
    if (sidebarLoginLink) {
      sidebarLoginLink.addEventListener('click', function(e) {
        e.preventDefault();
        openLoginModal();
      });
    }
  }

  // Configurar evento de envio do formulário de login
// ===================== MODAL DE LOGIN =====================
// Configurar evento de envio do formulário de login
const loginForm = document.getElementById('loginForm');
if (loginForm) {
  loginForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const remember = document.getElementById('remember').checked;
    
    const submitBtn = this.querySelector('.login-button');
    const buttonText = submitBtn.querySelector('.button-text');
    const originalText = buttonText.textContent;
    
    // Limpar erros anteriores
    hideLoginError();
    
    // Mostrar estado de carregamento
    submitBtn.disabled = true;
    buttonText.textContent = 'Entrando...';
    
    try {
      const formData = new URLSearchParams();
      formData.append('username', username);
      formData.append('password', password);
      if (remember) {
        formData.append('remember-me', 'on');
      }
      
      console.log('Enviando login...');
      
      const response = await fetch('/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest' // Indica que é AJAX
        },
        body: formData
      });
      
      console.log('Status da resposta:', response.status);
      console.log('Content-Type:', response.headers.get('content-type'));
      
      // Verificar se é JSON
      const contentType = response.headers.get('content-type');
      const isJson = contentType && contentType.includes('application/json');
      
      if (isJson) {
        const result = await response.json();
        console.log('Resposta JSON:', result);
        
        if (result.success) {
          // Login bem-sucedido via AJAX
          showLoginSuccess();
          
          setTimeout(() => {
            window.location.href = result.redirectUrl || '/';
          }, 1500);
          
        } else {
          // Erro do servidor
          showLoginError(result.message || 'Email ou senha incorretos');
          document.getElementById('password').value = '';
          document.getElementById('password').focus();
        }
      } else {
        // Não é JSON - pode ser redirecionamento HTML normal
        console.log('Resposta não é JSON, tratando como redirecionamento...');
        
        if (response.ok || response.status === 302) {
          // Login bem-sucedido (redirecionamento normal)
          showLoginSuccess();
          
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else if (response.status === 401 || response.status === 403) {
          // Credenciais inválidas
          showLoginError('Email ou senha incorretos');
          document.getElementById('password').value = '';
          document.getElementById('password').focus();
        } else {
          // Outro erro
          showLoginError('Erro ao fazer login. Tente novamente.');
        }
      }
      
    } catch (error) {
      console.error('Erro na requisição:', error);
      showLoginError('Erro de conexão. Verifique sua internet.');
    } finally {
      // Restaurar botão
      submitBtn.disabled = false;
      buttonText.textContent = originalText;
    }
  });
}

  // Configurar modal de login
  setupLoginModal();

  // ===================== VERIFICAR USUÁRIO LOGADO =====================
  verificarUsuarioAutenticado();

  // ===================== CONFIGURAR ÍCONE DO USUÁRIO =====================
  configurarIconeUsuario();

  // ===================== CONFIGURAR MODAL DE LOGOUT =====================
  const closeLogoutBtn = document.querySelector('.close-logout-modal');
  if (closeLogoutBtn) {
    closeLogoutBtn.addEventListener('click', closeLogoutModal);
  }
  
  const cancelLogoutBtn = document.querySelector('.logout-modal .cancel');
  if (cancelLogoutBtn) {
    cancelLogoutBtn.addEventListener('click', closeLogoutModal);
  }
  
  const logoutBtn = document.querySelector('.logout-modal .logout');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/logout';
      document.body.appendChild(form);
      form.submit();
    });
  }
  
  const logoutModal = document.getElementById('logoutModal');
  if (logoutModal) {
    logoutModal.addEventListener('click', function(e) {
      if (e.target === logoutModal) {
        closeLogoutModal();
      }
    });
  }

  // ===================== DATA ATUAL =====================
  const dateElement = document.getElementById('newspaperDate');
  if (dateElement) {
    const today = new Date();
    const meses = [
      "janeiro", "fevereiro", "março", "abril", "maio", "junho",
      "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
    ];
    const dia = today.getDate();
    const mes = meses[today.getMonth()];
    const ano = today.getFullYear();
    dateElement.textContent = `${dia} de ${mes} de ${ano}`;
  }

  // ===================== FILTROS DE RECEITAS =====================
  function filtrarReceitas() {
    const nomeFiltro = document.getElementById('nome')?.value.toLowerCase() || '';
    const tempoFiltro = parseInt(document.getElementById('tempo')?.value);
    const porcoesFiltro = parseInt(document.getElementById('porcoes')?.value);

    const cards = document.querySelectorAll('#all-recipes .card');

    cards.forEach(card => {
      const titulo = card.querySelector('h2')?.innerText.toLowerCase() || '';
      const tempoElement = card.querySelector('.card-meta span:first-child span');
      const porcoesElement = card.querySelector('.card-meta span:last-child span');
      
      const tempo = tempoElement ? parseInt(tempoElement.innerText) : 0;
      const porcoes = porcoesElement ? parseInt(porcoesElement.innerText) : 0;

      let mostrar = true;

      if (nomeFiltro && !titulo.includes(nomeFiltro)) mostrar = false;
      if (!isNaN(tempoFiltro) && tempo > tempoFiltro) mostrar = false;
      if (!isNaN(porcoesFiltro) && porcoes != porcoesFiltro) mostrar = false;

      card.style.display = mostrar ? 'block' : 'none';
    });
  }

  const filterForm = document.getElementById('filterForm');
  if (filterForm) {
    filterForm.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        filtrarReceitas();
      }
    });
  }

  const aplicarFiltros = document.getElementById('aplicarFiltros');
  if (aplicarFiltros) {
    aplicarFiltros.addEventListener('click', filtrarReceitas);
  }

  const limparFiltros = document.getElementById('limparFiltros');
  if (limparFiltros) {
    limparFiltros.addEventListener('click', () => {
      if (filterForm) filterForm.reset();
      const cards = document.querySelectorAll('#all-recipes .card');
      cards.forEach(card => card.style.display = 'block');
    });
  }

  // ===================== FECHAR MODAIS COM ESC =====================
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      // Fechar todos os modais abertos
      closeLoginModal();
      closeDeleteModal();
      closeLogoutModal();
      fecharModalUsuario();
      
      // Fechar sidebar
      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('show')) {
        toggleSidebar();
      }
    }
  });

// ===================== FORMULÁRIO DE EDIÇÃO DO USUÁRIO =====================
  const userEditForm = document.getElementById('userEditForm');
  if (userEditForm) {
    userEditForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const formData = new FormData(this);
      
      // Remover máscara do telefone antes de enviar
      const telefoneInput = document.getElementById('editTelefone');
      if (telefoneInput && telefoneInput.value) {
        const telefoneSemMascara = telefoneInput.value.replace(/\D/g, '');
        formData.set('telefone', telefoneSemMascara);
      }
      
      const dadosAtualizados = {
        nome: formData.get('nome'),
        email: formData.get('email'),
        telefone: formData.get('telefone'),
        genero: formData.get('genero'),
        senha: formData.get('senha'),
        confirmarSenha: formData.get('confirmarSenha')
      };
      
      // Validação de senha
      if (dadosAtualizados.senha && dadosAtualizados.senha !== dadosAtualizados.confirmarSenha) {
        showMessage('As senhas não coincidem', 'error');
        return;
      }
      
      // Se a senha estiver vazia, remover do objeto
      if (!dadosAtualizados.senha || dadosAtualizados.senha.trim() === '') {
        delete dadosAtualizados.senha;
        delete dadosAtualizados.confirmarSenha;
      }
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/perfil/editar', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'include',
          body: JSON.stringify(dadosAtualizados)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showMessage(result.message || 'Perfil atualizado com sucesso!', 'success');
          
          // Atualizar o nome no header se foi alterado
          if (dadosAtualizados.nome) {
            const nomeUsuarioElement = document.querySelector('.newspaper-subtitle span');
            if (nomeUsuarioElement) {
              nomeUsuarioElement.textContent = dadosAtualizados.nome;
            }
          }
          
          // Fechar o modal após 1.5 segundos
          setTimeout(fecharModalUsuario, 1500);
        } else {
          showMessage(result.message || 'Erro ao atualizar perfil', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showMessage('Erro de conexão ao atualizar perfil', 'error');
      } finally {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });
  }

  // ===================== EVENT LISTENERS PARA FECHAR MODAIS =====================
  const closeUserModalBtn = document.querySelector('.close-user-modal');
  if (closeUserModalBtn) {
    closeUserModalBtn.addEventListener('click', fecharModalUsuario);
  }

  const userModal = document.getElementById('userModal');
  if (userModal) {
    userModal.addEventListener('click', function(event) {
      if (event.target === this) {
        fecharModalUsuario();
      }
    });
  }
});

// ===================== FUNÇÕES DE FORMATAÇÃO =====================
function formatarTelefone(telefone) {
  if (!telefone) return '';
  
  // Remove tudo que não é dígito
  const digits = telefone.replace(/\D/g, '');
  
  // Aplica máscara baseada no tamanho
  if (digits.length === 11) {
    return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  } else if (digits.length === 10) {
    return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
  } else if (digits.length === 9) {
    return digits.replace(/(\d{5})(\d{4})/, '$1-$2');
  } else if (digits.length === 8) {
    return digits.replace(/(\d{4})(\d{4})/, '$1-$2');
  }
  
  return digits; // Retorna sem formatação se não for tamanho conhecido
}

function aplicarMascaraTelefoneInput(input) {
  let value = input.value.replace(/\D/g, '');
  
  if (value.length > 11) {
    value = value.substring(0, 11);
  }
  
  if (value.length === 11) {
    // Formato: (99) 99999-9999
    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  } else if (value.length === 10) {
    // Formato: (99) 9999-9999
    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
  } else if (value.length > 6) {
    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
  } else if (value.length > 2) {
    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
  } else if (value.length > 0) {
    value = value.replace(/(\d{0,2})/, '($1');
  }
  
  input.value = value;
}

</script>
</body>
</html>